#!/bin/sh

FILE=$1
[ -z "$1" ] && FILE='/tmp/diag_report'

hostname=$(hostname)
DATE=$(date)

echo "nbdump: $DATE" > $FILE

echo '***********************************************************************' >> $FILE
echo '* XTM' >> $FILE
echo '***********************************************************************' >> $FILE
# NB4 debug
[ "${hostname}" = "nb4" ] && iomem 0xfffe000c 8
[ "${hostname}" = "nb4" ] && iomem 0xfffe3200 64
[ "${hostname}" = "nb4" ] && iomem 0xfffe2000 1888

# NB6 debug
xdslctl show --stats >> $FILE
xtmctl operate intf --stats >> $FILE
[ "${hostname}" = "nb6" ] && iomem 0xb0007800 424 >> $FILE
[ "${hostname}" = "nb6" ] && iomem 0xb000bc00 24 >> $FILE
[ "${hostname}" = "nb6" ] && iomem 0xb000bc00 24 >> $FILE
echo '***********************************************************************' >> $FILE

# wireless
echo '***********************************************************************' >> $FILE
echo '* wlctl dump' >> $FILE
echo '***********************************************************************' >> $FILE
wlctl dump >> $FILE

echo '***********************************************************************' >> $FILE
echo '* wlctl smfstats' >> $FILE
echo '***********************************************************************' >> $FILE
wlctl smfstats >> $FILE
echo '***********************************************************************' >> $FILE

echo '***********************************************************************' >> $FILE
echo '* switch' >> $FILE
echo '***********************************************************************' >> $FILE
[ -x /usr/sbin/switch-robo ] && switch-robo stats >> $FILE
[ -x /usr/sbin/rtk-switch ] && rtk-switch stats show >> $FILE
echo '***********************************************************************' >> $FILE

echo '***********************************************************************' >> $FILE
echo '* sfp-diag' >> $FILE
echo '***********************************************************************' >> $FILE
sfp-diag >> $FILE

echo '***********************************************************************' >> $FILE
echo '* cat /proc/driver/eth0/dma_summary' >> $FILE
echo '***********************************************************************' >> $FILE
cat /proc/driver/eth0/dma_summary >> $FILE

echo '***********************************************************************' >> $FILE
echo '* ledctl list' >> $FILE
echo '***********************************************************************' >> $FILE
ledctl list >> $FILE

echo '***********************************************************************' >> $FILE
echo '* status show' >> $FILE
echo '***********************************************************************' >> $FILE
status show >> $FILE

echo '***********************************************************************' >> $FILE
echo '* nvram show' >> $FILE
echo '***********************************************************************' >> $FILE
nvram show >> $FILE

echo '***********************************************************************' >> $FILE
echo '* autoconf show' >> $FILE
echo '***********************************************************************' >> $FILE
autoconf show >> $FILE

for i in $(ls /tmp/autoconf/*)
do
	echo '***********************************************************************' >> $FILE
	echo "cat $i" 		>> $FILE
	echo '***********************************************************************' >> $FILE
	cat $i 			>> $FILE
done

echo '***********************************************************************' >> $FILE
echo '* cat /var/log/*' >> $FILE
echo '***********************************************************************' >> $FILE
for file in $(ls /var/log/* | grep -v /var/log/log)
do
	echo      ----- Start $file ----- >> $FILE
	cat $file >> $FILE
	echo      -----  End $file  ----- >> $FILE
done

echo '***********************************************************************' >> $FILE
echo '* ps faux' >> $FILE
echo '***********************************************************************' >> $FILE
ps faux >> $FILE

echo '***********************************************************************' >> $FILE
echo '* ifconfig' >> $FILE
echo '***********************************************************************' >> $FILE
ifconfig >> $FILE

echo '***********************************************************************' >> $FILE
echo 'cat /etc/hosts' >> $FILE
echo '***********************************************************************' >> $FILE
cat /etc/hosts >> $FILE

echo '***********************************************************************' >> $FILE
echo 'cat /etc/resolv.conf' >> $FILE
echo '***********************************************************************' >> $FILE
cat /etc/resolv.conf >> $FILE

echo '***********************************************************************' >> $FILE
echo 'ip rule show' >> $FILE
echo '***********************************************************************' >> $FILE
ip rule show >> $FILE

echo '***********************************************************************' >> $FILE
echo 'ip route' >> $FILE
echo '***********************************************************************' >> $FILE
ip mroute >> $FILE

echo '***********************************************************************' >> $FILE
echo 'ip mroute' >> $FILE
echo '***********************************************************************' >> $FILE
ip route >> $FILE

echo '***********************************************************************' >> $FILE
echo 'ip route show table lan_t' >> $FILE
echo '***********************************************************************' >> $FILE
ip route show table lan_t >> $FILE

echo '***********************************************************************' >> $FILE
echo 'ip route show table hotspot_t' >> $FILE
echo '***********************************************************************' >> $FILE
ip route show table hotspot_t >> $FILE

echo '***********************************************************************' >> $FILE
echo 'ip route show table tv_t' >> $FILE
echo '***********************************************************************' >> $FILE
ip route show table tv_t >> $FILE

echo '***********************************************************************' >> $FILE
echo 'ip route show table data_t' >> $FILE
echo '***********************************************************************' >> $FILE
ip route show table data_t >> $FILE

echo '***********************************************************************' >> $FILE
echo 'ip route show table local' >> $FILE
echo '***********************************************************************' >> $FILE
ip route show table local >> $FILE

echo '***********************************************************************' >> $FILE
echo 'ip route show table main' >> $FILE
echo '***********************************************************************' >> $FILE
ip route show table main >> $FILE

echo '***********************************************************************' >> $FILE
echo 'ip route show table default' >> $FILE
echo '***********************************************************************' >> $FILE
ip route show table default >> $FILE

echo '***********************************************************************' >> $FILE
echo 'iptables -L -n' >> $FILE
echo '***********************************************************************' >> $FILE
iptables -L -n -v >> $FILE

echo '***********************************************************************' >> $FILE
echo 'iptables -L -n -t nat' >> $FILE
echo '***********************************************************************' >> $FILE
iptables -L -n -v -t nat >> $FILE

echo '***********************************************************************' >> $FILE
echo 'iptables -L -n -t mangle' >> $FILE
echo '***********************************************************************' >> $FILE
iptables -L -n -v -t mangle >> $FILE

echo '***********************************************************************' >> $FILE
echo 'ebtables -L' >> $FILE
echo '***********************************************************************' >> $FILE
ebtables -L >> $FILE

echo '***********************************************************************' >> $FILE
echo 'cat /var/dnsmasq.leases' >> $FILE
echo '***********************************************************************' >> $FILE
cat /var/dnsmasq.leases >> $FILE

echo '***********************************************************************' >> $FILE
echo 'cat /proc/bus/usb/devices' >> $FILE
echo '***********************************************************************' >> $FILE
cat /proc/bus/usb/devices >> $FILE

echo '***********************************************************************' >> $FILE
echo 'netstat -s' >> $FILE
echo '***********************************************************************' >> $FILE
netstat -s >> $FILE

echo '***********************************************************************' >> $FILE
echo 'netstat -plantugewox' >> $FILE
echo '***********************************************************************' >> $FILE
netstat -plantugewox >> $FILE

# IPv6
echo '***********************************************************************' >> $FILE
echo 'ip -6 addr show' >> $FILE
echo '***********************************************************************' >> $FILE
ip -6 addr show >> $FILE

echo '***********************************************************************' >> $FILE
echo 'ip -6 route show' >> $FILE
echo '***********************************************************************' >> $FILE
ip -6 route show >> $FILE

echo '***********************************************************************' >> $FILE
echo 'ip -6 mroute show' >> $FILE
echo '***********************************************************************' >> $FILE
ip -6 mroute show >> $FILE

echo '***********************************************************************' >> $FILE
echo 'ip -6 maddr show' >> $FILE
echo '***********************************************************************' >> $FILE
ip -6 maddr show >> $FILE

echo '***********************************************************************' >> $FILE
echo 'ip -6 neigh show' >> $FILE
echo '***********************************************************************' >> $FILE
ip -6 neigh show >> $FILE

echo '***********************************************************************' >> $FILE
echo 'ip6tables -L -n -v' >> $FILE
echo '***********************************************************************' >> $FILE
ip6tables -L -n -v >> $FILE

echo '***********************************************************************' >> $FILE
echo 'cat /proc/interrupts' >> $FILE
echo '***********************************************************************' >> $FILE
cat /proc/interrupts >> $FILE

echo '***********************************************************************' >> $FILE
echo 'cat /proc/stat' >> $FILE
echo '***********************************************************************' >> $FILE
cat /proc/stat

echo '***********************************************************************' >> $FILE
echo 'cat /proc/loadavg' >> $FILE
echo '***********************************************************************' >> $FILE
cat /proc/loadavg

for i in $(ls /proc/net/*)
do
	echo '***********************************************************************' >> $FILE
	echo "cat $i" 		>> $FILE
	echo '***********************************************************************' >> $FILE
	cat $i 			>> $FILE
done

echo "nbdump: End of dump (`date`)" >> $FILE

# Remove '\0' characters to make the file readable after
sed -i 's/£$¤//g' $FILE
